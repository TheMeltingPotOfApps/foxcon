[DynamicIVR]

; Transfer error handler - invalid or missing transfer number (must be before 's' extension)
exten => transfer_error,1,NoOp(ERROR: Transfer number is empty or invalid)
 same => n,NoOp(Transfer Number: ${TRANSFER_NUMBER}, Final Transfer Number: ${FINAL_TRANSFER_NUMBER}, Trunk: ${TRUNK})
 same => n,UserEvent(TransferError,UniqueID: ${UNIQUEID},TransferNumber: ${TRANSFER_NUMBER},Message: Transfer number is empty or invalid,CallID: ${CUSTOM_CALL_ID})
 same => n,Set(transfer_status=error)
 same => n,Goto(end_call,1)

exten => s,1,NoOp(=== DYNAMIC IVR DIALER START ===)
 same => n,NoOp(Lead Number (to): ${to})
 same => n,NoOp(Our DID (from): ${from})
 same => n,NoOp(Agent Number: ${transfer_number})
 same => n,NoOp(IVR File: ${ivr_file})
 same => n,NoOp(IVR Voicemail: ${ivr_vm_file})
 same => n,NoOp(Wait Strategy: ${wait_strategy})

 ; Normalize variable names (handle both lowercase and uppercase from backend)
 ; Priority: uppercase > lowercase > default
 same => n,Set(transfer_number=${IF($["${TRANSFER_NUMBER}" != ""]?${TRANSFER_NUMBER}:${transfer_number})})
 same => n,Set(trunk=${IF($["${TRUNK}" != ""]?${TRUNK}:${IF($["${trunk}" != ""]?${trunk}:MC)})})
 same => n,Set(ivr_file=${IF($["${IVR_FILE}" != ""]?${IVR_FILE}:${ivr_file})})
 same => n,Set(ivr_vm_file=${IF($["${IVR_VM_FILE}" != ""]?${IVR_VM_FILE}:${ivr_vm_file})})
 same => n,Set(wait_strategy=${IF($["${WAIT_STRATEGY}" != ""]?${WAIT_STRATEGY}:${IF($["${wait_strategy}" != ""]?${wait_strategy}:random)})})
 same => n,Set(press_key=${IF($["${PRESS_KEY}" != ""]?${PRESS_KEY}:${IF($["${press_key}" != ""]?${press_key}:1)})})
 same => n,Set(amd_enabled=${IF($["${AMD_ENABLED}" != ""]?${AMD_ENABLED}:${IF($["${amd_enabled}" != ""]?${amd_enabled}:true)})})

 ; Set standardized uppercase variables for dialplan use
 same => n,Set(TRANSFER_NUMBER=${transfer_number})
 same => n,Set(TRUNK=${trunk})
 same => n,Set(IVR_FILE=${IF($["${ivr_file}" != ""]?${ivr_file}:custom/HRDSHIPP1IVR)})
 same => n,Set(IVR_VM_FILE=${IF($["${ivr_vm_file}" != ""]?${ivr_vm_file}:custom/HRDSHIPVM)})
 same => n,Set(WAIT_STRATEGY=${wait_strategy})
 same => n,Set(PRESS_KEY=${press_key})
 same => n,Set(AMD_ENABLED=${amd_enabled})
 
 ; Normalize TO_NUMBER variable (use uppercase if available, otherwise lowercase to)
 ; TO_NUMBER is passed from backend and contains the formatted lead number in E164 format (+17065551234)
 same => n,Set(TO_NUMBER=${IF($["${TO_NUMBER}" != ""]?${TO_NUMBER}:${to})})

 ; Set call tracking variables
 same => n,Set(CALL_START_TIME=${EPOCH})
 same => n,Set(CDR(userfield)=dynamicivr)
 same => n,Set(CUSTOM_CALL_ID=${IF($["${custom_call_id}" != ""]?${custom_call_id}:${UNIQUEID})})

 ; Send initial call status event
 same => n,UserEvent(CallStatus,UniqueID: ${UNIQUEID},Status: initiated,Message: DynamicIVR call initiated to ${to},CallID: ${CUSTOM_CALL_ID})

 same => n,Answer()
 same => n,Wait(0.5)

 ; Send answered status
 same => n,UserEvent(CallStatus,UniqueID: ${UNIQUEID},Status: answered,Message: Call answered,CallID: ${CUSTOM_CALL_ID})
 same => n,Set(call_status=answered)

 ; AMD Detection - DISABLED
 ; same => n,GotoIf($["${AMD_ENABLED}" != "true"]?human,1)
 ; same => n,NoOp(AMD Detection Enabled - Starting detection)
 ; same => n,UserEvent(CallStatus,UniqueID: ${UNIQUEID},Status: amd_started,Message: AMD detection started,CallID: ${CUSTOM_CALL_ID})
 ; same => n,AMD()
 ; same => n,NoOp(AMD Status: ${AMDSTATUS})
 ; same => n,UserEvent(CallStatus,UniqueID: ${UNIQUEID},Status: amd_completed,Message: AMD detection completed - Status: ${AMDSTATUS},CallID: ${CUSTOM_CALL_ID})
 ; same => n,GotoIf($["${AMDSTATUS}" = "HUMAN"]?human,1:machine,1)
 same => n,Goto(human,1)

; Human detected - proceed with IVR using Background/WaitExten (allows DTMF during playback)
exten => human,1,NoOp(Human detected - proceeding with IVR (Background method - DTMF can be pressed anytime))
 same => n,UserEvent(CallStatus,UniqueID: ${UNIQUEID},Status: human_detected,Message: Human detected, proceeding with IVR,CallID: ${CUSTOM_CALL_ID})
 same => n,Set(IVR_START_TIME=${EPOCH})
 same => n,UserEvent(IVRStarted,UniqueID: ${UNIQUEID},IVRFile: ${IVR_FILE},CallID: ${CUSTOM_CALL_ID})
 same => n,NoOp(Playing IVR with Background: ${IVR_FILE} - Press ${PRESS_KEY} at ANY TIME to transfer)
 same => n,Set(TIMEOUT(digit)=30)
 same => n,Set(TIMEOUT(response)=30)
 ; Background plays the file and allows DTMF detection during playback
 same => n,Background(${IVR_FILE})
 same => n,WaitExten(90)
 ; If no digit pressed during playback, go to timeout
 same => n,NoOp(Background completed - no digit pressed during playback)
 same => n,Goto(read_timeout,1)

; Handle digit presses during Background playback (0-9, *, #)
exten => 0,1,NoOp(Digit 0 pressed during IVR playback)
 same => n,Set(digit=0)
 same => n,Goto(check_digit,1)
exten => 1,1,NoOp(Digit 1 pressed during IVR playback)
 same => n,Set(digit=1)
 same => n,Goto(check_digit,1)
exten => 2,1,NoOp(Digit 2 pressed during IVR playback)
 same => n,Set(digit=2)
 same => n,Goto(check_digit,1)
exten => 3,1,NoOp(Digit 3 pressed during IVR playback)
 same => n,Set(digit=3)
 same => n,Goto(check_digit,1)
exten => 4,1,NoOp(Digit 4 pressed during IVR playback)
 same => n,Set(digit=4)
 same => n,Goto(check_digit,1)
exten => 5,1,NoOp(Digit 5 pressed during IVR playback)
 same => n,Set(digit=5)
 same => n,Goto(check_digit,1)
exten => 6,1,NoOp(Digit 6 pressed during IVR playback)
 same => n,Set(digit=6)
 same => n,Goto(check_digit,1)
exten => 7,1,NoOp(Digit 7 pressed during IVR playback)
 same => n,Set(digit=7)
 same => n,Goto(check_digit,1)
exten => 8,1,NoOp(Digit 8 pressed during IVR playback)
 same => n,Set(digit=8)
 same => n,Goto(check_digit,1)
exten => 9,1,NoOp(Digit 9 pressed during IVR playback)
 same => n,Set(digit=9)
 same => n,Goto(check_digit,1)
exten => *,1,NoOp(Digit * pressed during IVR playback)
 same => n,Set(digit=*)
 same => n,Goto(check_digit,1)
exten => #,1,NoOp(Digit # pressed during IVR playback)
 same => n,Set(digit=#)
 same => n,Goto(check_digit,1)

; Check if pressed digit matches PRESS_KEY
exten => check_digit,1,NoOp(User pressed: [${digit}], Expected: [${PRESS_KEY}])
 same => n,Set(IVR_END_TIME=${EPOCH})
 same => n,UserEvent(IVRResponse,UniqueID: ${UNIQUEID},Response: ${digit},Digits: ${digit},ExpectedKey: ${PRESS_KEY},CallID: ${CUSTOM_CALL_ID})
 same => n,GotoIf($["${digit}" = "${PRESS_KEY}"]?transfer,1:hangup,1)

; Transfer branch
exten => transfer,1,NoOp(Transferring call to ${TRANSFER_NUMBER})
 same => n,UserEvent(TransferAttempt,UniqueID: ${UNIQUEID},TransferNumber: ${TRANSFER_NUMBER},CallID: ${CUSTOM_CALL_ID})
 same => n,Set(TRANSFER_START_TIME=${EPOCH})
 
 ; Set caller ID to lead's number (not the DID) - use TO_NUMBER which contains the formatted lead number
 ; TO_NUMBER is set from backend and contains the lead number in E164 format (+17065551234)
 same => n,Set(LEAD_NUMBER=${IF($["${TO_NUMBER}" != ""]?${TO_NUMBER}:${to})})
 same => n,NoOp(Setting caller ID for transfer: Lead=${LEAD_NUMBER}, DID=${from}, Original to=${to}, TO_NUMBER=${TO_NUMBER})
 same => n,Set(CALLERID(all)=${LEAD_NUMBER})
 same => n,Set(CALLERID(num)=${LEAD_NUMBER})
 same => n,Set(CALLERID(name)=${LEAD_NUMBER})
 
 ; Process transfer number: strip + sign and non-digits, convert E164 to dialable format
 ; Transfer number comes in E164 format (e.g., +15551234567) - strip + and use digits only
 same => n,Set(FINAL_TRANSFER_NUMBER=${FILTER(0-9,${TRANSFER_NUMBER})})
 same => n,GotoIf($["${FINAL_TRANSFER_NUMBER}" = ""]?transfer_error,1)
 
 ; Ensure trunk is set (default to MC if not specified)
 same => n,Set(FINAL_TRUNK=${IF($["${TRUNK}" != ""]?${TRUNK}:MC)})
 
 ; Dial format: PJSIP/{number}@{trunk}
 ; Number is already in E164 format without + sign (e.g., 15551234567)
 ; Use 'o' option to override caller ID presentation for the transfer
 same => n,NoOp(Dialing PJSIP/${FINAL_TRANSFER_NUMBER}@${FINAL_TRUNK} with caller ID: ${LEAD_NUMBER})
 same => n,Progress()
 same => n,Ringing()
 same => n,Dial(PJSIP/${FINAL_TRANSFER_NUMBER}@${FINAL_TRUNK},30,Ttgo)
 same => n,Set(TRANSFER_END_TIME=${EPOCH})
 same => n,Set(TRANSFER_DURATION=$[${TRANSFER_END_TIME} - ${TRANSFER_START_TIME}])
 same => n,UserEvent(TransferResult,UniqueID: ${UNIQUEID},Status: ${DIALSTATUS},Duration: ${TRANSFER_DURATION},CallID: ${CUSTOM_CALL_ID})
 same => n,GotoIf($["${DIALSTATUS}" = "ANSWER"]?transfer_connected,1)
 same => n,GotoIf($["${DIALSTATUS}" = "BUSY"]?transfer_busy,1)
 same => n,GotoIf($["${DIALSTATUS}" = "NOANSWER"]?transfer_noanswer,1)
 same => n,Goto(transfer_failed,1)

; Transfer connected
exten => transfer_connected,1,NoOp(Transfer connected successfully)
 same => n,Set(TRANSFER_END_TIME=${EPOCH})
 same => n,Set(TRANSFER_DURATION=$[${TRANSFER_END_TIME} - ${TRANSFER_START_TIME}])
 same => n,UserEvent(TransferConnected,UniqueID: ${UNIQUEID},TransferNumber: ${TRANSFER_NUMBER},Duration: ${TRANSFER_DURATION},CallID: ${CUSTOM_CALL_ID})
 same => n,Set(transfer_status=completed)
 same => n,Goto(end_call,1)

; Transfer busy
exten => transfer_busy,1,NoOp(Transfer number busy)
 same => n,UserEvent(TransferBusy,UniqueID: ${UNIQUEID},TransferNumber: ${TRANSFER_NUMBER},CallID: ${CUSTOM_CALL_ID})
 same => n,Set(transfer_status=busy)
 same => n,Goto(end_call,1)

; Transfer no answer
exten => transfer_noanswer,1,NoOp(Transfer number no answer)
 same => n,UserEvent(TransferNoAnswer,UniqueID: ${UNIQUEID},TransferNumber: ${TRANSFER_NUMBER},CallID: ${CUSTOM_CALL_ID})
 same => n,Set(transfer_status=no_answer)
 same => n,Goto(end_call,1)

; Transfer failed
exten => transfer_failed,1,NoOp(Transfer failed)
 same => n,UserEvent(TransferFailed,UniqueID: ${UNIQUEID},TransferNumber: ${TRANSFER_NUMBER},Reason: ${DIALSTATUS},CallID: ${CUSTOM_CALL_ID})
 same => n,Set(transfer_status=failed)
 same => n,Goto(end_call,1)

; Machine detected - leave voicemail
exten => machine,1,NoOp(Answering Machine Detected)
 same => n,UserEvent(CallStatus,UniqueID: ${UNIQUEID},Status: machine_detected,Message: Answering machine detected,CallID: ${CUSTOM_CALL_ID})
 same => n,Wait(2)
 same => n,NoOp(Playing voicemail: ${IVR_VM_FILE})
 same => n,UserEvent(CallStatus,UniqueID: ${UNIQUEID},Status: playing_voicemail,Message: Playing voicemail ${IVR_VM_FILE},CallID: ${CUSTOM_CALL_ID})
 same => n,Playback(${IVR_VM_FILE})
 same => n,GotoIf($["${WAIT_STRATEGY}" = "none"]?end_machine)
 same => n,GotoIf($["${WAIT_STRATEGY}" = "fixed"]?fixed_wait_machine)
 same => n,Set(wait_time=$[${RAND(1,23)}])
 same => n,Goto(wait_machine)
 same => n(fixed_wait_machine),Set(wait_time=15)
 same => n(wait_machine),NoOp(Waiting ${wait_time} seconds)
 same => n,UserEvent(CallStatus,UniqueID: ${UNIQUEID},Status: voicemail_wait,Message: Waiting ${wait_time} seconds after voicemail,CallID: ${CUSTOM_CALL_ID})
 same => n,Wait(${wait_time})
 same => n(end_machine),UserEvent(CallStatus,UniqueID: ${UNIQUEID},Status: voicemail_completed,Message: Voicemail process completed,CallID: ${CUSTOM_CALL_ID})
 same => n,Hangup()

; Hangup branch - invalid input or no input
exten => hangup,1,NoOp(Invalid input received - hanging up)
 same => n,UserEvent(CallStatus,UniqueID: ${UNIQUEID},Status: ivr_declined,Message: IVR declined or invalid input,CallID: ${CUSTOM_CALL_ID})
 same => n,Set(transfer_status=declined)
 same => n,Goto(end_call,1)

; End call and calculate duration
exten => end_call,1,NoOp(====== Call Ending ======)
 same => n,Set(CALL_END_TIME=${EPOCH})
 same => n,Set(CALL_DURATION=$[${CALL_END_TIME} - ${CALL_START_TIME}])
 same => n,NoOp(Call Duration: ${CALL_DURATION} seconds)
 same => n,UserEvent(CallStatus,UniqueID: ${UNIQUEID},Status: completed,Message: Call completed after ${CALL_DURATION} seconds,Duration: ${CALL_DURATION},FinalStatus: ${call_status},CallID: ${CUSTOM_CALL_ID})
 same => n,Wait(1)
 same => n,Hangup()

; Hangup handler for unexpected disconnections
exten => h,1,NoOp(====== Hangup Handler ======)
 same => n,Set(CALL_END_TIME=${EPOCH})
 same => n,Set(CALL_DURATION=$[${CALL_END_TIME} - ${CALL_START_TIME}])
 same => n,NoOp(Call ended unexpectedly - Duration: ${CALL_DURATION} seconds)
 same => n,UserEvent(CallStatus,UniqueID: ${UNIQUEID},Status: hangup,Message: Call ended,Duration: ${CALL_DURATION},FinalStatus: ${call_status},HangupCause: ${HANGUPCAUSE},CallID: ${CUSTOM_CALL_ID})

; Error handling
exten => i,1,NoOp(Invalid extension)
 same => n,UserEvent(CallStatus,UniqueID: ${UNIQUEID},Status: error,Message: Invalid extension,CallID: ${CUSTOM_CALL_ID})
 same => n,Hangup()

exten => t,1,NoOp(Timeout - checking if this is Read timeout)
 same => n,GotoIf($["${digit}" = ""]?read_timeout,1)
 same => n,NoOp(General timeout)
 same => n,UserEvent(CallStatus,UniqueID: ${UNIQUEID},Status: timeout,Message: Call timeout,CallID: ${CUSTOM_CALL_ID})
 same => n,Hangup()

; Read timeout handler - user didn't press a key
exten => read_timeout,1,NoOp(Read timeout - no digit pressed)
 same => n,UserEvent(CallStatus,UniqueID: ${UNIQUEID},Status: ivr_timeout,Message: IVR timeout - no digit pressed,ExpectedKey: ${PRESS_KEY},CallID: ${CUSTOM_CALL_ID})
 same => n,Set(transfer_status=timeout)
 same => n,Goto(end_call,1)

